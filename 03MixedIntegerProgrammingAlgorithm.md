# 3 Mixed Integer Programming Algorithm

- 3.1 混合整数规划的定义
- 3.2 一种直观的算法运行时间分析方法
- 3.3 分支定界法(Branch and Bound)的形式化
- 3.4 一种先验重构方法来收紧初始数学约束的主要步骤，包括不等式检验、公式的好或坏、理想凸包、严格重构等重要概念
- 3.5 以分离算法(Separation)和切割平面算法（Cut-plane）为基础的分支定法的形式化
- 3.6 基础的构造和改进启发算法来获得更快更好的可行解，并于分支定界法结合。

## 3.1 混合整数线性规划

**定义3.1** 混合整数规划 MIP
$$
Z(X) = \text{min} \{cx+fy:(x,y)\in X\},
$$

$$
X={(x,y)\in\mathbb{R}^n_+\times\mathbb{Z}^p_+:Ax+By\geq b}
$$

式中：

- $Z(X)$优化目标
- $x,y$表示n为的非负连续变量和非负整数变量
- $c\in\mathbb{R}^n, f\in\mathbb{R}^p$表示优化目标系数
- $b\in\mathbb{R}^m$，为线性约束的边界值
- $A,B$表示线性约束系数

**定义3.2 **0-1整数规划 MBP
$$
Z(X) = \text{min} \{cx+fy:(x,y)\in X\}
$$

$$
X={(x,y)\in\mathbb{R}^n_+\times\{0,1\}^p:Ax+By\geq b}
$$

0-1整数规划的约束可以通过线性松弛转换为线性约束，我们定义$P_X$为线性松弛后的最优解的定义域
$$
P_X = \{x, y\}\in\mathbb{R}_+^n\times[0,1]^p:Ax+By\geq b
$$
**定义3.3** 线性松弛的整数规划
$$
Z(P_X) = \text{min} \{cx+fy:(x,y)\in X\}
$$

$$
P_X = \{x, y\}\in\mathbb{R}_+^n\times\mathbb{R}_+^p:Ax+By\geq b, P_X\supseteq X
$$

式中：

- $P_X$为松弛后的的解定义域

**推论3.1**对于最小优化目标来说，松弛后的最小目标值小于或等于原值，为目标的下限。
$$
Z(P_X)\leq Z(X)
$$
**推论3.2**对于最小优化目标来说，任意的可行解都是优化目标的上限



下面通过一个简单的案例，来演示MIP问题中如何使用分支定界和剪枝算法。该问题中只有两个整型变量，是一个纯整数规划问题（pure integer programming)
$$
Z(X) = \text{min} \{-y_1-2y_2:y=(y_1,y_2)\in X\}
$$

$$
\begin{aligned}
X=\{y=(y_1, y_2)\in \mathbb{Z}_+^2:& y_1&\geq& 1\\
&-y_1 &\geq& -5\\
&-y_1-0.8y_2 &\geq&-5.8\\
&y_1-0.8y_2 &\geq&0.2 \\
&-y_1-8y_2 &\geq&-26
\}\end{aligned}
$$

在该问题中，$n=A=c=0$
$$
m=5,p=2,f=(1,2),B=\begin{pmatrix}&1 &0\\
&-1&0\\
&-1 &-0.8\\
&1&-0.8\\
&-1&-8\end{pmatrix}
,b=\begin{pmatrix}
-1\\
-5\\
-5.8\\
0.2\\
-26
\end{pmatrix}
$$
![image-20210104165237403](https://gitee.com/behe-moth/picgo_img/raw/master/pic/image-20210104165237403.png)

该问题的可行解，松弛后的约束范围以及目标方向可以用图3.1表示

## 3.2 算法运行时间

在开始求解MIP问题之前，首先了解以下一些算法评价和分析的标准方法。

### 3.2.1 算法的性能

考虑有问题$P$和算法$A$

评价算法有两个维度，速度和质量。速度的时值算法的运行时间，质量则是算法得到目标值的好坏（例如 duality gap）。算法的运行时间通常并直接使用运行时间来评价，而是使用其[复杂度](https://zh.wikipedia.org/wiki/%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6)来评价，该指标于硬件速度、软件平台、编译器等外界因素无关。

问题可以按照其数学模型的结构进行分类，对于同一类问题来说，算法求解的耗时有一定共性。例如对于LS-U的问题，其复杂度与维度有关，为
$$
N(A,n) = 3\frac{n(n-1)}{2} + n^2
$$
更确切的，我们使用$O(n^p)$来表示复杂度与问题规模的关系，$O(n)$表示随问题规模线性增长，$O(n^2)$表示随问题规模的平方增长。

**问题的规模**

对于LS-U问题，通常由$3n$个变量和$2n$条约束，仪表我们使用
$$
O(n)\times O(n)
$$
来表示其规模，规模并不表示其复杂度，只是表示其问题大小。

## 3.3 分支定界法

回顾以下之前的PIP问题

我们首先将MIP问题通过线性松弛变换成了如下形式
$$
Z(V) = \text{min}\{cx+fy:(x,y)\in V\}
$$
式中$V$表示问题的线性空间

问题的原始约束如下
$$
X = \{(x,y)\in\mathbb{R}_+^n\times \mathbb{Z}_+^p:Ax+By\geq b\}
$$
线性松弛后的最优解$Z(P_X)$的线性空间如下
$$
P_X = \{(x,y)\in\mathbb{R}_+^n\times\mathbb{R}_+^p:Ax+By\geq b\}
$$

问题的上限和下限
$$
Z(P_X)\leq Z(X)\leq \bar{Z}
$$
式中$\bar{Z}$表示问题任意的可行解

### 3.3.1 枚举原则

首先说明分支定界法在解决MIP问题时，最基本的分治原则。

1. $Z(X)$的下限来自于线性松弛后的最优解$Z(P_X)$。线性问题通常可以快速求解，令$(x^*,y^*)$为线性问题的最优解。

   **假设**  一般来说，我们假设线性松弛后的问题是有界的，否则$Z(P_X)=-\infty$，则MIP问题将是无边界或者是不可行。为了区分这两种情况，我们给变量设置一个足够大的上下限，然后运行分支定界法，如果找到了最优解，那么问题无边界否则问题不可行。

   求解MIP问题，可以理解在线性空间$P_X$ 内寻找最优的$(x,y)$且满足$y\in\mathbb{Z}^p$

   **原则**  我们通过求解一系列LP问题来尝试求解MIP问题

2. 如果$y^*\in\mathbb{Z}^p$，那么$(x^*,y^*)\in X$也满足，所以问题的上限和下限相等，$(x^*,y^*)$为最优解。
$$
  cx^*+fy^*=Z(P_X)\leq Z(X)\leq \bar{Z}=cx^*+fy^*
$$


3. 如果$y^*\notin\mathbb{Z}^p$，那么$(x^*,y^*)$不是MIP的可行解。我们会通过添加一些线性约束的方式，来消除无用的线性松弛。

   令$y_j,j\in\{1,2,\cdots,p\}$表示线性松弛问题最优解$y^*$中非整数的变量。

   **注意**  对于任何的可行解$(x,y)\in X$，显然有$y_j\lfloor y^*_j\rfloor$或者$y_j\geq \lceil y^*_j\rceil$，$\lfloor y_j^*\rfloor,\lceil y^*_j\rceil$分别表示对$y_j^*$向下和向上取整。例如，$y_j^*=\frac{32}{9}$，则有$y_j\leq 3=\lfloor\frac{32}{9}\rfloor$或者$y_j\geq 4=\lceil\frac{32}{9}\rceil$

   **分支**  为了消除$(x^*,y^*)$中的不可行值，我们将$P_X$分成$P_X^0,P_X^1$两个部分
   $$
   P_X^0=P_X\cap\{(x,y)\in\mathbb{R}_+^n\times \mathbb{R}_+^p:y_j\leq \lfloor y_j^*\rfloor\}
   $$

   $$
   P_X^1=P_X\cap\{(x,y)\in\mathbb{R}_+^n\times \mathbb{R}_+^p:y_j\geq \lceil y_j^*\rceil\}
   $$

   式中，$y_j$被称为分支变量，$y_j\leq \lfloor y_j^*\rfloor, y_j\geq\lceil y_j^*\rceil$被称为分支约束。

   现在，我们可以将问题由在$P_X$中寻找最优解替换成在$P_X^0\cup P_X^1$中寻找最优解，代价就是我们将一个线性问题变成了两个线性问题。

   **案例**  图3.1中的问题，经过线性松弛后，得到解$(x^*,y^*)$为$a=(\frac{32}{9},\frac{101}{36})$，将$P_X$在分支变量$y_1$处分成$P_X^0,P_X^1$ ，如图3.2所示

   ![image-20210105105349131](https://gitee.com/behe-moth/picgo_img/raw/master/pic/image-20210105105349131.png)

4. 我们继续在分解后的线性空间$L=\{P_X^0,P_X^1\}$寻找最优解，在遇到非整数解是继续将问题分解，并添加到列表$L$中，然后不断递归。

   **主迭代** 我们给出列表$L$和当前的最佳可行解$\bar{Z}$，没有可行解时，令$\bar{Z}=+\infty$

   **选择和求解**  选择列表L中的一个线性空间$V$，求解线性规划问题，得到$Z(V)$和最优的变量取值$(x^V,y^V)$，$Z(V)$就是线性空间$V$内的目标下限值

   **剪枝**  在线性空间$V$内可能由以下几种情况

   a. 如果$Z(V)\geq \bar{Z}$，那么空间$V$内不存在严格优于$\bar{Z}$的解，我们不需要在检验$Z(V)$的边界是否在整数上，直接从列表$L$中删除$V$即可，这是修剪边界

   b. 一种特殊情况是如果$V$是空集，我们可以得到$Z(V)=+\infty\geq \bar{Z}$，也可以排除$V$，这是修剪不可行域

   c. 如果$Z(V)<\bar{Z},y^V\in \mathbb{Z}^p$，那么我们在空间$V$可以找到最优解$Z(V)$和对应的变量值$(x^V,y^V)$，且该解优于当前的可行解，因此令$\bar{Z}=Z(V)$，然后将$V$从列表中移除。

   d. 如果$Z(V)<\bar{Z},y^V\notin\mathbb{Z}^p$，那么空间$V$内的解不是整数，因此需要将$V$分支成$V^0,V^1$，然后添加到列表$L$中，这被称为分支。

5. **终止条件** 算法会在列表$L$为空后终止，如果$y$是有限的话，此时算法可以保证在有限步骤内找到全局的最优解。需要注意的是，列表$L$的空间数量会随着整数变量维度$p$指数增长。

   **复杂度** 理论上分支定界法的迭代次数随整数变量的维度$p$指数增长，每次迭代都包括一次线性规划的计算（大约是多项式复杂度）

### 3.3.2 分支定界算法

我们将分支定界算法归纳如下

1. *初始化*

   *$L=\{P_X\}$*

   *$\bar{Z}=+\infty$*

   *假设$Z(P_X)>-\infty$*

2. *终止条件*

   *if $L=\empty$*

   ​	*if $\bar{Z}=+\infty$，问题无解（infeasible）*

   ​	*if $\bar{Z}<+\infty$，最优解为$\bar{Z}$*

   ​	*stop*

3. *节点选择和求解*

   *选择$V\in L$，令$L=L\backslash \{V\}$*

   *对子空间$V$进行线性求解得到$Z(V),(x^V,y^V)$*

4. *剪枝*

   *if $Z(V)\geq \bar{Z}$，goto 2*

   *if $Z(V)<\bar{Z}$，*

   ​	*if $y^V\in\mathbb{Z}^p$*

   ​		*update $\bar{Z}=Z(V)$*

   ​		*update $L$: for $W\in L$ : if $Z(W)\geq \bar{Z}$，$L=L\backslash{W}$*

   ​		*goto 2*	

5. *分支*

   *$L=L\cup\{V^0,V^1\}$*

   *$V^0 = V \cap \{ (x,y) \in \mathbb{R}_+^n \times \mathbb{R}_+^p : y_j \leq \lfloor y_j^V \rfloor \}$*

   *$V^1=V \cap \{ (x,y) \in \mathbb{R}_+^n \times \mathbb{R}_+^p : y_j \geq \lceil y_j^V \rceil\}$*

   *goto 2*


​    ![](https://gitee.com/behe-moth/picgo_img/raw/master/pic/image-20210106142628381.png)

分支列表$L$通常会使用枚举树来表示其结构，下图为案例的分支遍历，以及对应点在问题空间的未知。

![image-20210106092116750](https://gitee.com/behe-moth/picgo_img/raw/master/pic/image-20210106093324276.png)

![image-20210106093324276](https://gitee.com/behe-moth/picgo_img/raw/master/pic/image-20210106092116750.png)

### 3.3.3 节点选择和分支的策略

节点选择指在子空间列表$L$选择下一个节点进行计算步骤。选择的节点关系到算法搜索过程中的上下限的收敛速度，一般来说常见的策略有：

- DFS，深度优先
- BFS，广度优先
- 最佳边界，选择具有最小的下限的节点
- 混合策略：先BFS后DFS，先DFS后最佳边界等

大多数的选择策略都是启发式的。DFS可以较快的获得一个可行解（通常来说，遍历越深，越容易得到整数解），但是解的质量难以保证。BFS则更容易找到全局较有的分支，但是在寻找可行解时效率会变差。

分支策略是如何选择分支变量的步骤。最常用的是选择$y^*$最接近0.5的变量。

大多数的MIP求解器都会包含基础的选择和分支策略，也支持实现自定义的策略。

### 3.3.4 结果的质量

优化结果的好坏通常使用[对偶间隙](https://zh.wikipedia.org/wiki/%E5%B0%8D%E5%81%B6%E9%96%93%E9%9A%99)（Duality Gap）来评价。
$$
Duality Gap = \frac{Best UB-Best LB}{BestUB}\times100\%
$$
$BestUB$为最佳的可行解，$BestLB$为最佳的线性松弛解。需要注意的是，大多数优化求解器使用$BestLB$作为对偶间隙的分母。

## 3.4 重构

使用分支定界法就可以完成MIP问题的求解，但是难点在于，大多数实际的问题，变量太多，导致计算复杂度指数增长，以至于在有限时间内无法保证结果。因此多数时候，需要对模型的方程进行适当的重构，改善模型的求解性能。

### 3.4.1 方程的质量

**方程的好与坏**

**结论3.3** *分支定界法在求解MIP问题时需要计算的节点数量很大程度上取决于方程形式，因此需要掌握如何辨别方程的好坏。*

在PIP的案例当中，我们在图3.3中的求解共遍历了9个节点，其方程形式如下
$$
\begin{aligned}
X=P_X\cap\mathbb{Z}_+^2\quad \text{and} \quad P_X=\{y=(y_1,y_2)\in\mathbb{R}_+^2\}:&y_1&\geq&1\\\
&-y_1&\geq&-5\\
&-y_1-0.8y_2&\geq&-5.8\\
&y_1-0.8y_2&\geq&0.2\\
&-y_1-8y_2&\geq&-26
\end{aligned}
$$
可行域范围在图3.1中阴影表示，观察图形可以发现，对于所有的可行解来说，可以新增一些约束进一步缩小范围
$$
\begin{aligned}
-y_1-y_2 & \geq&  6, \\
y_1-y_2  & \geq&  0, \\
-y_2      & \geq& -2.
\end{aligned}
$$
在图3.5中表示处新的约束范围后发现，原来的MIP问题只需要一次LP计算就可以得到结果，因为最优解$f$就在约束边界上。

![image-20210106142628381](https://gitee.com/behe-moth/picgo_img/raw/master/pic/branch_and_bound_flowchart.svg)

**严格或凸的公式化**

上述例子中的方程形式可以使用纯粹的LP方法来求解PIP问题，这是因为新的线性松弛与$X$的凸包完全一致。这些新增的约束被称为有效不等式。$X$的凸包，$\text{conv}(X)$可以理解为最小的或者最严格的包含所有$X$点的公式化线性约束，同时它也是最佳的公式化约束形式。$X$中所有的边界点都在约束边界，因此无论目标函数如何变化，最终都可以通过LP一次找到最佳解。

**结论3.4** *MIP问题都可以通过一组表示可行域$X$的凸包线性有效不等式将原问题重构，转换成一个纯粹的LP问题求解。这种方式，也被称为严格公式化。用来描述$X$的凸包的不等约束又被称为多面体。*

但是，在实际的应用中，该方法有两个主要难点。

1. $X$的凸包是未知的，寻找凸包通常来说是和求解MIP问题同样复杂的。
2. 大多数MIP问题的$\text{conv}(X)$的方程个数随变量数同样有指数增长的问题，这可能导致线性问题难以求解。

因此，我们不能指望在实际的应用中使用你先的严格公式化方法。我们会在3.5继续讨论第二点困难。

### 3.4.2 有效不等式

在开始优化之前，添加一些有效不等式或者约束有以下目的：

- 获得一个严格的公式化形式
- 提高下限值
- 减少求解过程中分支定界法的节点数量
- 减少分支定界法的耗时

**定义3.10** 有效不等式(Valid Inequalities, VI)定义如下：
$$
\forall\quad (x^{\star},y^{\star})\in X, \quad \alpha x^\star+\beta y^\star\geq \gamma\\
\begin{aligned}
\text{with}\quad& X=\{(x,y)\in\mathbb{R}_+^n\times\mathbb{Z}_+^p:Ax+By\geq b\},\\
& \alpha \in \mathbb{R}^n, \beta\in\mathbb{R}^p,\gamma\in\mathbb{R}
\end{aligned}
$$
换句话说，$\alpha x^\star+\beta y^\star\geq \gamma$是有效不等式的充分条件是该不等式需包含$X$内部所有的点。

显然并没所有的有效不等式都是我们关心的，我们关心的VI更多是那些严格的处于边界的不等式，只有这些不等式才有利于改善分支定界法的搜索性能。

**定义3.11**  *$X$的面指描述$\text{conv}(X)$多面体的必要的不等式。*

通常来说，定义多面体的有效不等式是非常困难的，因此，更多时候我们只能对模型进行部分的收紧，以期望可以减少分支数量和算法耗时。

**松弛分析和有效不等式寻找**

在数学上有一些判断、分类可行域$X$的有效不等式的方法，但是这些方法的解释已经超过本书的范畴。这里我们简单的演示一些通用的方法来帮助读者足够使用已有的重构结论和软件，更好的理解重构和将为方法，并为第二部分做准备。

通常来说，判断凸包$X$的面需要全面考虑其结构，显然这过于困难，因此我们一般会使用其超集$Y$来简化问题。

**结论3.5** *超集$Y$的任何有效不等式也是$X$的有效不等式*

